## Сервис авторизации

Авторизация через OAuth доступна через сервис `google` и `yandex` на ендпоинтах `/user/oauth/login/google` и `/user/oauth/login/yandex` соответственно. Для работы необходимо указать клиентские id и secret в .env файле (как в [примере](https://github.com/SergeyP1990/auth-api/blob/ef66674e75a4dfab746a27f2b6adc6545e0c16df/example.env#L18-L22))

Интеграция с сервисом `async-api` затрагивает изменения в репозитории async-api, а именно этот [pull request](https://github.com/SergeyP1990/async-api/commit/5c1acebb1caa454ecdc66efee571e8b70c58b6d1) (и небольшой [фикс](https://github.com/SergeyP1990/async-api/commit/7834d3f9d1a81c58b230c686d29c39dfeead534d) для него следом). Фильмам в `async-api` выставляются флаги с требованием подписки `subscribe_required`. Наличие роли `subscriber` у пользователя позволяет ему получить доступ к фильму, а отсутствие этой роли приводит к возврату ошибки.

### Требования:
  - python3 >= 3.8.10
  - [docker-compose](https://docs.docker.com/compose/install/) >= 1.29.2

### Установка:
1) Склонировать репозиторий
`git clone https://github.com/SergeyP1990/auth-api`
2) На примере .env_example создать в корне репозитория файл .env и заполнить его необходимыми данными
3) Далее перейти в директорию с репозиторием и запустить docker-compose
  ```
  cd auth-api
  docker-compose up -d --build
  ```
 4) Выполнить первоначальные миграции. Для этого выполнить команды:
  ```
  docker-compose exec auth-api flask db migrate -m "initial"
  docker-compose exec auth-api flask db upgrade
  ```


### Описание:

Ознакомиться с описанием openapi можно по [ссылке](https://github.com/SergeyP1990/auth-api/blob/0450aaac4cc5b8c31cd706469ae70ca50311b67b/open_api_spec.yml) ([SwaggerHub](https://app.swaggerhub.com/apis/myteam8896/auth-api/1.0.0))

Сервис предоставляет возможность идентификации, аутентификации, авторизации и регистрации пользователей. Информация о пользователях хранится в базе данных Postgres в таблице `users`. Пароли хранятся в хэшированном виде.

#### Идентификация и аутентификация

Для поддержания сессии залогиненного пользователя сервис использует JWT токены. Access и refresh токены выдаются пользователю после логина. Вместе с ними выдаются csrf токены, которые необходимо предъявлять сервису при запросах в заголовках. Access токен короткоживущий, содержит идентификатор пользователя и используется для доступа к ендпоинтам, refresh токен существует дольше (время действия токенов указывается в настройках через .env), является одноразовым и используется при окончании срока жизни access токена для создания новой пары access и refresh токенов.

Refresh токен хранится в Redis в db1, в db0 хранятся access токены, которые были использованы при `logout`.

#### Авторизация

В сервисе реализовано ограничение прав пользователей. В базе данных Postgres хранятся роли в таблице `roles`, а ассоциирование ролей с пользователями осуществялется через таблицу `user_role`. После предъявления JWT токена на ендпоинте происходит извлечение идентификатора пользователя из токена и проверка его текущих прав на действия в этом ендпоинте. 

#### Защита ендпоинтов
##### Защита ендпоинтов сервиса авторизации

Защита ендпоинтов сервиса (CRUD ролей и изменение данных пользователей) реализована в самом коде сервиса. Для доступа к CRUD ролей и изменением данных пользователей (пользователь может изменять данные сам себе без проверки роли) пользователь должен обладать ролью `admin`. Помимо этого в базе данных присутствует роль `superadmin`, позволяющая пользователю с этой ролью всегда успешно проходить авторизацию.

###### Суперпользователь

Суперпользователь обладает разершением на любые действия в сервисе. Назначить роль `superadmin` пользователю можно либо через API /role, либо через командную строку. Для назначения роли `superadmin` пользователю через консоль необходимо:
1) Подключиться к контейнеру сервиса авторизации, выполнив команду `docker-compose exec auth-api "/bin/bash"`
2) В контейнере выполнить команду `python3 app.py grant-superuser <user_name>`, где `<user_name>` - логин пользователя, которому вы хотите выдать права суперпользователя.

Так же через консоль можно создавать пользователей. Синтаксис команды: `python3 app.py register-user <user_name> <password>`

##### Защита ендпоинтов стороннего сервиса

Для проверки возможности доступа у какому-либо ресурсу сторонний сервис может выполнить запрос к ендпоинту /role/user/{user_id}/role/{role_id}. Для выполнения проверки необходимо предоставить jwt токен с идентификатором пользователя, у которого есть либо роль `admin`, либо роль `role_checker`
